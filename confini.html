<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#6C5CE7">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Puzzle">
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="icon.svg">
<title>Confini - Puzzle Game</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

  :root {
    --bg: #faf8f5;
    --card: #ffffff;
    --primary: #6C5CE7;
    --primary-light: #e8e4fd;
    --text: #2d2d2d;
    --text-muted: #777777;
    --success: #00b894;
    --error: #d63031;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    user-select: none;
    -webkit-user-select: none;
  }

  header {
    width: 100%;
    max-width: 500px;
    padding: 16px 20px 8px;
    text-align: center;
    position: relative;
  }

  header h1 {
    font-size: 28px;
    font-weight: 700;
    letter-spacing: 2px;
    color: var(--primary);
    text-transform: uppercase;
  }

  header p {
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 2px;
  }

  .toolbar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    padding: 8px 20px;
    width: 100%;
    max-width: 500px;
  }

  .btn {
    border: none;
    border-radius: 20px;
    padding: 8px 18px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
  }

  .btn:active { transform: scale(0.95); }

  .btn-primary {
    background: var(--primary);
    color: #fff;
  }

  .btn-primary:hover { background: #5a4bd6; }

  .stats-line {
    font-size: 12px;
    color: var(--text-muted);
    text-align: center;
    padding: 0 20px 8px;
  }

  .game-area {
    width: 100%;
    max-width: 500px;
    padding: 0 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  /* --- Mode selector --- */
  .mode-selector {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
    padding: 4px 0;
  }

  .mode-chip {
    padding: 6px 14px;
    border-radius: 20px;
    border: 2px solid #e0e0e0;
    background: var(--card);
    font-size: 13px;
    font-weight: 600;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.15s;
  }

  .mode-chip:active { transform: scale(0.95); }
  .mode-chip.active {
    border-color: var(--primary);
    background: var(--primary-light);
    color: var(--primary);
  }

  /* --- Question card --- */
  .question-card {
    background: var(--card);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .question-label {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .question-visual {
    width: 200px;
    height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 16px;
    background: var(--primary-light);
    overflow: hidden;
  }

  .question-visual .flag-display {
    font-size: 120px;
    line-height: 1;
  }

  .question-visual svg {
    width: 180px;
    height: 180px;
  }

  .timer-bar {
    width: 100%;
    height: 6px;
    background: #e8e8e8;
    border-radius: 3px;
    overflow: hidden;
  }

  .timer-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 3px;
    width: 100%;
    transition: width 0.1s linear;
  }

  .timer-fill.warning { background: #f39c12; }
  .timer-fill.danger { background: var(--error); }

  .timer-text {
    font-size: 14px;
    font-weight: 700;
    color: var(--text-muted);
    font-variant-numeric: tabular-nums;
  }

  /* --- Options --- */
  .options {
    width: 100%;
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .option-btn {
    width: 100%;
    padding: 14px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 14px;
    background: var(--card);
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    cursor: pointer;
    text-align: center;
    transition: all 0.2s;
    line-height: 1.3;
  }

  .option-btn:active { transform: scale(0.98); }
  .option-btn:hover { border-color: var(--primary); background: var(--primary-light); }

  .option-btn.correct { border-color: var(--success); background: #e8f5e9; color: #2e7d32; }
  .option-btn.wrong { border-color: var(--error); background: #fdecea; color: #c62828; }
  .option-btn.dimmed { opacity: 0.4; pointer-events: none; }

  /* --- Score dots --- */
  .score-dots {
    display: flex;
    gap: 6px;
    justify-content: center;
    flex-wrap: wrap;
    padding: 4px 0;
  }

  .score-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #e0e0e0;
    transition: background 0.3s, transform 0.3s;
  }

  .score-dot.current { transform: scale(1.3); border: 2px solid var(--primary); background: #fff; }
  .score-dot.correct { background: var(--success); }
  .score-dot.wrong { background: var(--error); }

  /* --- Loading / Error --- */
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
    padding: 40px 20px;
    color: var(--text-muted);
    font-size: 16px;
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 4px solid #e8e8e8;
    border-top-color: var(--primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* --- Result --- */
  .result-container {
    background: var(--card);
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    width: 100%;
    text-align: center;
    animation: fadeIn 0.4s ease;
  }

  .result-title { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
  .result-title.great { color: var(--success); }
  .result-title.ok { color: #f39c12; }
  .result-title.bad { color: var(--error); }

  .result-score { font-size: 48px; font-weight: 800; color: var(--primary); margin: 8px 0; }

  .result-detail { font-size: 14px; color: var(--text-muted); margin-bottom: 16px; line-height: 1.6; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .instructions {
    max-width: 500px;
    padding: 12px 20px 24px;
    text-align: center;
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.5;
  }

  /* --- Stats Modal --- */
  .overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }

  .overlay.visible { display: flex; }

  .modal {
    background: var(--card);
    border-radius: 20px;
    padding: 32px;
    max-width: 340px;
    width: 90%;
    text-align: center;
    animation: pop 0.3s ease;
  }

  @keyframes pop {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }

  .modal h2 { font-size: 22px; margin-bottom: 16px; color: var(--primary); }
  .modal .stat-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 15px;
  }
  .modal .stat-row:last-child { border-bottom: none; }
  .modal .stat-label { color: var(--text-muted); }
  .modal .stat-value { font-weight: 700; color: var(--text); }

  /* --- Answer feedback --- */
  .answer-info {
    font-size: 14px;
    color: var(--text-muted);
    text-align: center;
    margin-top: 4px;
    font-weight: 600;
    animation: fadeIn 0.3s ease;
  }
  .answer-info.correct-info { color: var(--success); }
  .answer-info.wrong-info { color: var(--error); }
</style>
</head>
<body>

<header>
  <a href="index.html" style="position:absolute;left:16px;top:16px;color:var(--primary);text-decoration:none;font-size:18px;font-weight:600;">&larr; Menu</a>
  <button id="btnStats" style="position:absolute;right:16px;top:16px;background:none;border:none;font-size:22px;cursor:pointer;color:var(--primary);">&#x1F3C6;</button>
  <h1>Confini</h1>
  <p>Riconosci stati e bandiere</p>
</header>

<div class="toolbar">
  <div class="mode-selector" id="modeSelector"></div>
</div>

<div class="toolbar" id="startToolbar">
  <button class="btn btn-primary" id="btnStart">Nuova partita</button>
</div>

<p class="stats-line" id="statsLine"></p>

<div class="game-area" id="gameArea"></div>

<p class="instructions" id="instructions">
  Riconosci lo stato dalla sua <strong>sagoma</strong> o dalla <strong>bandiera</strong>.<br>
  <strong>10 round</strong> per partita. Vince chi risponde pi&ugrave; velocemente!
</p>

<!-- Stats Modal -->
<div class="overlay" id="statsOverlay">
  <div class="modal">
    <h2>Statistiche</h2>
    <div id="statsContent"></div>
    <button class="btn btn-primary" style="margin-top:16px;" onclick="document.getElementById('statsOverlay').classList.remove('visible')">Chiudi</button>
  </div>
</div>

<script>
// ─── Seeded PRNG (Mulberry32) ───────────────────────────────────
function mulberry32(seed) {
  return function() {
    seed |= 0; seed = seed + 0x6D2B79F5 | 0;
    let t = Math.imul(seed ^ seed >>> 15, 1 | seed);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}

function shuffleArray(arr, rng) {
  const fn = rng || Math.random;
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(fn() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

// ─── Country Database ───────────────────────────────────────────
// Accurate SVG paths from world-map-country-shapes (MIT, simplemaps.com)
const COUNTRIES_RAW = [
  { name: 'Italia', flag: '\u{1F1EE}\u{1F1F9}', shape: "M1057.8 328.6l-4 .5-5.2.7-6.2-.6-.6 3.4 7.5 3.3 2.7.7 4.2 2.4.9-3.3-.9-2 1.6-5.1zm-33.7-18.9l-2.5 1.9-2.8-.3 1.3 3.6.4 7.6 2.1 1.7 2-2.1 2.4.4.4-8.4-3.3-4.4zm14.3-34.3l-1.3-2.2-4.8 1.1-.5 1.2-3.1-.9-.3 2.5-2.1 1.1-3.8-.8-.9 2.5-2.4.2-.9-1-2.7 2.1-2.4.3-2.2-1.3-.2 1.7 1.6 2.4-1.7 1.8 1.5 4.8 2.7.8-.5 2.7 2.1-.5 2.8-2.8 2.3-.9 4.2 2.1 2.6.7 1.9 6 3.6 3.6 4.9 4 4.2 2.8 3.9.4 2.3 2.5 3.4 1.2 1.7 2.7 2.2.8 1.8 3.2 2.3 3.7-1.1 1.3-.8 3.5.1 2 2.1-.5 2.5-5.6 2.1-.4.4-3.3-3.9-2.3 1.9-4.1 4.5 1 3.1 3 .8-2.3-.6-1.2-4.7-3.2-3.9-1.9-4.8-2.3 1.4-1.2-1.4-1.4-4 .1-6-5-2.9-5.1-4.9-3.1-1.9-3.1.5-1.8-.4-3 3.9-2.2 4.1.9-1.4-2.7.3-3-7.2-1.6z" },
  { name: 'Francia', flag: '\u{1F1EB}\u{1F1F7}', shape: "M1025.7 303.8l-1.1-5.2-3.2 2.3-1 2.3 1.4 4.2 2.4 1.2 1.5-4.8zm-31.5-50.9l-2.4-2.4-2.2-.1-.7-2.2-4.3 1.2-1.4 5.1-11.3 4.8-4.6-2.6 1.4 7-8.2-1.6-6.4 1.3.4 4.6 7.5 2.4 3.6 3.1 5.1 6.5-1 12.3-2.7 3.7 2 2.4 9.4 2.8 1.9-1.3 5.7 2.8 6-.8.5-3.7 7.4-2 10 1.6 4.5-3.4.5-2.7-2.7-.8-1.5-4.8 1.7-1.8-1.6-2.4.2-1.7-1.8-2.7-2.4.9v-2.8l3.5-3.5-.2-1.6 2.3.6 1.3-1 .5-4.5 2.3-4.2-7.1-1.2-2.4-1.6-1.4.1-1.1-.5-4.4-2.8-2.5.4-3.4-2.9z" },
  { name: 'Germania', flag: '\u{1F1E9}\u{1F1EA}', shape: "M1043.6 232.3l-2.4-1.9-5.5-2.4-2.5 1.7-4.7 1.1-.1-2.1-4.9-1.4-.2-2.3-3 .9-3.6-.8.4 3.4 1.2 2.2-3 3-1-1.3-3.9.3-.9 1.3 1 2-1 5.6-1.1 2.3h-2.9l1.1 6.4-.4 4.2 1 1.4-.2 2.7 2.4 1.6 7.1 1.2-2.3 4.2-.5 4.5h4.2l1-1.4 5.4 1.9 1.5-.3 2.6 1.7.6-1.6 4.4.3 3.4-1.2 2.4.2 1.7 1.3.4-1.1-1-4 1.7-.8 1.5-2.9-2.9-2.6-2.6-1.5-.7-2.6-1-1.9 3.4-1.3 1.7-1.5 3.4-1.2 1.1-1.2 1.4.7 2.1-.6-2.3-3.9.1-2.1-1.4-3.3-2-2.2 1.2-1.6-1.4-3.1z" },
  { name: 'Spagna', flag: '\u{1F1EA}\u{1F1F8}', shape: "M985 325.7v-.2h-.5l-.3-.4-.1.2-.1.2v.2h.5l.4.1.1-.1zm-.8-1.6h.3l.6-.7v-.3l-.3-.2-1.1.2-.2.3v.3l-.3.1-.1.4.1.2.8.1.2-.4zM967 296l-8.2-.2-4.2.3-5.4-1h-6.8l-6.2-1.1-7.4 4.5 2 2.6-.4 4.4 1.9-1.6 2.1-.9 1.2 3.1h3l.9-.8 3 .2 1.3 3.1-2.4 1.7-.2 4.9-.9.9-.3 3-2.2.5 2 3.8-1.6 4.3 1.8 1.9-.8 1.7-2 2.5.4 2.1 4.8 1 1.4 3.7 2 2.2 2.5.6 2.1-2.5 3.3-2.3 5 .1h6.7l3.8-5 3.9-1.3 1.2-4.2 3-2.9-2-3.7 2-5.1 3.1-3.5.5-2.1 6.6-1.3 4.8-4.2-.3-3.5-6 .8-5.7-2.8-1.9 1.3-9.4-2.8-2-2.4zm26 22.6l.1-.3.1-.2.1-.1-.2-.2v-.1l.2-.2-.2-.1-1.3.4-.7.4-2.1 1.5v.3l.1.2h.4l.2.4.4-.4.3-.1.3.1.3.2.1.6.1.2.6.1.9.4.4-.2.5-.3.2-.6.3-.5.3-.5.3-.4-.1-.4-.3-.1-.3-.1-.5.2-.5-.2zm6-.3l.1-.4v-.1l-.5-.7-.9-.3-1 .1-.1.1v.4l.1.1.6.1 1.6.7h.1z" },
  { name: 'Regno Unito', flag: '\u{1F1EC}\u{1F1E7}', shape: "M950 227.5l-4.9-3.7-3.9.3.8 3.2-1.1 3.2 2.9-.1 3.5 1.3 2.7-4.2zm13-24.3l-5.5.5-3.6-.4-3.7 4.8-1.9 6.1 2.2 3 .1 5.8 2.6-2.8 1.4 1.6-1.7 2.7 1 1.6 5.7 1.1h.1l3.1 3.8-.8 3.5-7.1-.6-1 4 2.6 3.3-5.1 1.9 1.3 2.4 7.5 1-4.3 1.3-7.3 6.5 2.5 1.2 3.5-2.3 4.5.7 3.3-2.9 2.2 1.2 8.3-1.7 6.5.1 4.3-3.3-1.9-3.1 2.4-1.8.5-3.9-5.8-1.2-1.3-2.3-2.9-6.9-3.2-1-4.1-7.1-.4-.6-4.8-.4 4.2-5.3 1.3-4.9h-5l-4.7.8 5-6.4z" },
  { name: 'Portogallo', flag: '\u{1F1F5}\u{1F1F9}', shape: "M937.6 335.9l-.4-2.1 2-2.5.8-1.7-1.8-1.9 1.6-4.3-2-3.8 2.2-.5.3-3 .9-.9.2-4.9 2.4-1.7-1.3-3.1-3-.2-.9.8h-3l-1.2-3.1-2.1.9-1.9 1.6.1 2.1.9 2.2.1 2.7-1.3 3.8-.4 2.5-2.2 2.3-.6 4.2 1.2 2.4 2.3.6.4 4-1 5.1 2.8-.7 2.7.9 2.2-1.7z" },
  { name: 'Grecia', flag: '\u{1F1EC}\u{1F1F7}', shape: "M1101.9 344.9l-.8 2.8 6.6 1.2v1.1l7.6-.6.5-1.9-2.8.8v-1.1l-3.9-.5-4.1.4-3.1-2.2zm11.5-37.4l-2.7-1.6.3 3-4.6.6-3.9-2.1-3.9 1.7-3.8-.2-1 .2-.7 1.1-2.8-.1-1.9 1.3-3.3.6v1.6l-1.6.9-.1 2.1-2.1 3 .5 1.9 2.9 3.6 2.3 3 1.3 4.3 2.3 5.1 4.6 2.9 3.4-.1-2.4-5.7 3.3-.7-1.9-3.3 5 1.7-.4-3.7-2.7-1.8-3.2-3 1.8-1.4-2.8-3-1.6-3.8.9-1.3 3 3.2h2.9l2.5-1-3.9-3.6 6.1-1.6 2.7.6 3.2.2 1.1-.7 1.2-3.9z" },
  { name: 'Brasile', flag: '\u{1F1E7}\u{1F1F7}', shape: "M659 560.1l-1.4.2-3.1-.5-1.8 1.7-2.6 1.1-1.7.2-.7 1.3-2.7-.3-3.5-3-.3-2.9-1.4-3.3 1-5.4 1.6-2.2-1.2-3-1.9-.9.8-2.8-1.3-1.5-2.9.3.7 1.8-2.1 2.4-6.4 2.4-4 1-1.7 1.5-4.4-1.6-4.2-.8-1 .6 2.4 1.6-.3 4.3.7 4 4.8.5.3 1.4-4.1 1.8-.7 2.7-2.3 1-4.2 1.5-1.1 1.9-4.4.5-3-3.4-1.1.8-1-3.8-1.6-2-1.9 2.2-10.9-.1v3.9l3.3.7-.2 2.4-1.1-.6-3.2 1v4.6l2.5 2.4.9 3.6-.1 2.8-2.2 17.4-5.1-.3-.7 1-4.6 1.2-6.2 4.3-.4 3-1.3 2.2.7 3.4-3.3 1.9.1 2.7-1.5 1.1 2.6 5.8 3.3 3.8-1 2.8 3.7.3 2.3 3.4 4.9.2 4.4-3.8.2 9.7 2.6.7 3-1.1 4.2.6 2.9-.2 1.1-1.9 4.8-2.6 2.8-2.3 7.3-1.1-.4 4.7.9 2.5-.3 4.3 6.4 5.7 6.3 1 2.4 2.4 3.8 1.2 2.5 1.9 3.5-.1 3.3 1.9.5 3.7 1.2 1.8.3 2.8-1.6.1 2.7 7.4 10.7.3-.6 3.6.8 2.6 3.2 1.7 1.6 4-.5 5-1.3 2.8.8 3.6-1.6 1.3 1.9 3.6.4 8.6 6 1.2 2.1-1.2 3.9 1.7 1.2 1.9 1 5.8.9 2.5 2 .3 2-1.1 2.1 1.2.3 3.5-.3 3.8-.7 3.6 2.6-1.2 3.1 3.7.5 5.1-4.2 3.5-3.3 2.6-5.3 6.2-5.9 8.6 3.4-.7 6.2 4.9 1.9-.2 6.2 4.1 4.8 3.5 3.8 4.3-1.9 3 2.1 3.7 2.9-3.7 1.5-6 3.2-3 3.9-5 4.5-11.2 3.4-3.5.8-3.1.3-6.4-1.3-3.5.3-4.8 4.1-6.3 6-5.1 6-1.8 3.6-2.9 8.5-2.4h5.9l1.1-3.8 4.2-2.8.6-6.5 5.1-8.3.5-8.5 1.6-2.6.3-4.1 1.1-9.9-1-11.9 1.4-4.7 1.4-.1 3.9-5.5 3.3-7.2 7.7-8.8 2.7-4.2 2-10.5-1-3.9-2-8.1-2.1-2-4.8-.2-4.3-1.9-7.3-7.1-8.4-5.3-8.4.3-10.9-3.4-6.5 2 .8-3.5-2.7-3.8-9.4-3.8-7.1-2.3-4.2 4.1-.3-6.3-9.9-1-1.7-2 4.2-5.2-.1-4.4-3-1-3-11.2-1.3-3.5-1.9.3-3.5 5.8-1.8 4.7-2.1 2.4-2.7.5-.8-1.8-1.2-.3-1.8 1.8-2.4-1.3-3.2-1.4-2.7.7-2.3-.6-.5 1.8.9 1.3-.5 1.3-3.1-.5z" },
  { name: 'Turchia', flag: '\u{1F1F9}\u{1F1F7}', shape: "M1166.6 308.9l-9.7-4.4-8.5.2-5.7 1.7-5.6 4-9.9-.8-1.6 4.8-7.9.2-5.1 6.1 3.6 3-2 5 4.2 3.6 3.7 6.4 5.8-.1 5.4 3.5 3.6-.8.9-2.7 5.7.2 4.6 3.5 8-.7 3.1-3.7 4.6 1.5 3.2-.6-1.7 2.4 2.3 3 1.2-1.4 1.2-1.5-.1-3.6 1.9 1.3 5.5-1.8 3 1.2h4.3l5.7-2.5 2.8.2 5.9-1.1 2.1-1 6.2.9 2.1 1.6 2.3-1.1-3.7-5.2.7-2-2.9-7.3 3.3-1.8-2.4-1.9-4.2-1.5v-3.1l-1.3-2.2-5.6-3-5.4.3-5.5 3.2-4.5-.6-5.8 1-7.8-2.4zm-49.6 4l2-1.9 6.1-.4.7-1.5-4.7-2-.9-2.4-4.5-.8-5 2 2.7 1.6-1.2 3.9-1.1.7.1 1.3 1.9 2.9 3.9-3.4z" },
  { name: 'Egitto', flag: '\u{1F1EA}\u{1F1EC}', shape: "M1129.7 374.8l-5.5-1.9-5.3-1.7-7.1.2-1.8 3 1.1 2.7-1.2 3.9 2 5.1 1.3 22.7 1 23.4h65.3l-1-1.3-6.8-5.7-.4-4.2 1-1.1-5.3-7-2-3.6-2.3-3.5-4.8-9.9-3.9-6.4-2.8-6.7.5-.6 4.6 9.1 2.7 2.9 2 2 1.2-1.1 1.2-3.3.7-4.8 1.3-2.5-.7-1.7-3.9-9.2-2.5 1.6-4.2-.4-4.4-1.5-1.1 2.1-1.7-3.2-3.9-.8-4.7.6-2.1 1.8-3.9 2-2.6-1z" },
  { name: 'Sudafrica', flag: '\u{1F1FF}\u{1F1E6}', shape: "M1148.2 713.7l-2.9-.6-1.9.8-2.6-1.1-2.2-.1-8 4.7-5.2 4.7-2 4.3-1.7 2.4-3 .5-1.2 3-.6 2-3.6 1.5-4.4-.3-2.5-1.8-2.3-.8-2.7 1.5-1.5 3.1-2.7 1.9-2.8 2.8-4 .7-1.1-2.3.7-3.8-3-6.1-1.4-1-1.1 23.6-5 3.2-2.9.5-3.3-1.2-2.4-.5-.8-2.7-2.1-1.8-2.7 3.2 3.5 8.2v.1l2.5 5.3 3.2 6-.2 4.8-1.7 1.2 1.4 4.2-.2 3.8.6 1.7.3-.9 2.1 2.9 1.8.1 2.1 2.3 2.4-.2 3.5-2.4 4.6-1 5.6-2.5 2.2.3 3.3-.8 5.7 1.2 2.7-1.2 3.2 1 .8-1.8 2.7-.3 5.8-2.5 4.3-2.9 4.1-3.8 6.7-6.5 3.4-4.6 1.8-3.2 2.5-3.3 1.2-.9 3.9-3.2 1.6-2.9 1.1-5.2 1.7-4.7h-4.1l-1.3 2.8-3.3.7-3-3.5.1-2.2 1.6-3.2-.4-2.3 1.4-7.1-1.1-4.5-2.2-9zm-20.1 52.8l-2 .6-3.7-4.9 3.2-4 3.1-2.5 2.6-1.3 2.3 2 1.7 1.9-1.9 3.1-1.1 2.1-3.1 1-1.1 2z" },
  { name: 'Svezia', flag: '\u{1F1F8}\u{1F1EA}', shape: "M1077.7 161.1l-1.9-2.2-1.7-8.4-7.2-3.7-5.9-2.7-2.5.3v3.5l-7.9-.9-.6 3.1-4-.1-2.2 3.9-3.4 6.1-5.7 7.9 1.8 1.9-1.3 2.2-4.3-.1-2.3 5.3 1 7.6 3.1 2.9-.9 6.9-3.4 4-1.7 3.3 4.2 8.4 4.4 6.7 2 5.7 5.3-.3 2.2-4.7 5.7.5 2-5.5.6-10 4.6-1.3 3.3-6.6-4.8-3.3-3.6-4 2.1-8.1 7.7-4.9 6.1-4.5-1.2-3.5 3.4-3.9 7-1.5z" },
  { name: 'Norvegia', flag: '\u{1F1F3}\u{1F1F4}', shape: "M1088.8 133.1l-6.9 1.1-7.3-.3-5.1 4.4-6.7-.3-8.5 2.3-10.1 6.8-6.4 4-8.8 10.7-7.1 7.8-8.1 5.8-11.2 4.8-3.9 3.6 1.9 13.4 1.9 6.3 6.4 3 6-1.4 8.5-6.8 3.3 3.6 1.7-3.3 3.4-4 .9-6.9-3.1-2.9-1-7.6 2.3-5.3 4.3.1 1.3-2.2-1.8-1.9 5.7-7.9 3.4-6.1 2.2-3.9 4 .1.6-3.1 7.9.9v-3.5l2.5-.3 2.1-1.4 5.1 2.9 5.3-.3 4.7 1.3 3.4-2.4 1.1-3.9 5.8-1.8 5.7 2.1-.8 3.8 3.2-.5 6.4-2.2-5.4-3.3 4.8-1.4-13.6-3.9zm-22.6-33.3l-5.6-1-1.9-1.7-7.2.9 2.6 1.5-2.2 1.2 6.7 1.1 7.6-2zm-25.4-8.3l-4.8-1.6-5.1.2-1 1.5h-5l-2.2-1.5-9.3 1.6 3.2 3.5 7.6 3.8 5.7 1.4-3 1.7 8.4 2.9 4.4-.2.9-3.9 3-.9 1.2-3.4 8.5-1.8-12.5-3.3zm24.2-3.1l-9.1-1-3.2 1.2-5.3-1-10.4 1.2 4.3 2h5.1l.9 1.3 10.6.7 10.1-.5 4.3-2.4-7.3-1.5z" },
  { name: 'Polonia', flag: '\u{1F1F5}\u{1F1F1}', shape: "M1069.4 228.3l-4.6-.1-.5-1.4-4.8-1.1-5.7 2.1-7.1 2.8-3.1 1.7 1.4 3.1-1.2 1.6 2 2.2 1.4 3.3-.1 2.1 2.3 3.9 2.4 1.9 3.7.6-.1 1.7 2.7 1.2.6-1.5 3.4.6.7 2 3.6.3 2.6 3.1.3.4 1.9-.9 2.7 2.2 2.8-1.3 2.4.6 3.4-.8 4.9 2.3 1.1.4-1.6-2.8 3.8-5.1 2.3-.7.3-1.8-3.1-5.3-.5-2.7-1.9-2.9 2.7-1.2-.3-2.4-1.7-2.3-.6-2.7-1.4-1.9-2.5-.6-8.7.1-5.9-.7z" },
  { name: 'Svizzera', flag: '\u{1F1E8}\u{1F1ED}', shape: "M1024.3 270.6l-5.4-1.9-1 1.4h-4.2l-1.3 1-2.3-.6.2 1.6-3.5 3.5v2.8l2.4-.9 1.8 2.7 2.2 1.3 2.4-.3 2.7-2.1.9 1 2.4-.2.9-2.5 3.8.8 2.1-1.1.3-2.5-2.6-.2-2.3-1.1.7-1.6-.2-1.1z" },
  { name: 'Austria', flag: '\u{1F1E6}\u{1F1F9}', shape: "M1060.2 264l-2.3-1.2-2.3.3-4-1.9-1.7.5-2.6 2.5-3.8-2-1.5 2.9-1.7.8 1 4-.4 1.1-1.7-1.3-2.4-.2-3.4 1.2-4.4-.3-.6 1.6-2.6-1.7-1.5.3.2 1.1-.7 1.6 2.3 1.1 2.6.2 3.1.9.5-1.2 4.8-1.1 1.3 2.2 7.2 1.6 4.2.4 2.4-1.4 4.3-.1.9-1.1 1.3-4-1.1-1.3h2.8l.2-2.6-.7-2.1.3-.8z" },
  { name: 'Paesi Bassi', flag: '\u{1F1F3}\u{1F1F1}', shape: "M1005.5 243.9h2.9l1.1-2.3 1-5.6-1-2-3.9-.2-6.5 2.6-3.9 8.9-2.5 1.7 3.6.5 4.4-1.3 3.1 2.7 2.8 1.4-1.1-6.4z" },
  { name: 'Belgio', flag: '\u{1F1E7}\u{1F1EA}', shape: "M1000.7 246.2l-4.4 1.3-3.6-.5-3.8 1.2.7 2.2 2.2.1 2.4 2.4 3.4 2.9 2.5-.4 4.4 2.8.4-3.5 1.3-.2.4-4.2-2.8-1.4-3.1-2.7z" },
  { name: 'Irlanda', flag: '\u{1F1EE}\u{1F1EA}', shape: "M947.3 231.7l-3.5-1.3-2.9.1 1.1-3.2-.8-3.2-3.7 2.8-6.7 4.7 2.1 6.1-4.2 6.4 6.7.9 8.7-3.6 3.9-5.4-.7-4.3z" },
  { name: 'Croazia', flag: '\u{1F1ED}\u{1F1F7}', shape: "M1065 280.4l-4-2.6-1.6-.8-3.9 1.7-.3 2.5-1.7.6.2 1.7-2-.1-1.8-1-.8 1-3.5-.2-.2.1v2.2l1.7 2 1.3-2.6 3.3 1 .3 2 2.5 2.6-1 .5 4.6 4.5 4.8 1.8 3.1 2.2 5 2.3.5-1-4.7-2.4-2.2-2.5-2-1.4-2.5-2.3-1.3-1.9-2.7-2.9.9-2.5 1.9 1.4 1-1.3 2.3-.1 4.4 1 3.5-.1 2.4 1.4 1.7-2.3-1.7-1.8-1.5-2.4-1.8.9-4.2-1.2z" },
  { name: 'Romania', flag: '\u{1F1F7}\u{1F1F4}', shape: "M1108.1 266.3h-2.1l-1 1.5-3.6.6-1.6.9-2.4-1.5h-3.2l-3.2-.7-1.9 1.3-2.9 1.3-1.9 4.2-2.6 4.3-3.8 1.1 2.9 2.5.8 1.9 3.2 1.5.7 2.5 3.1 1.8 1.4-1.3 1.4.7-1.1 1.1 1 1 1.8 2.6 1.9-.5 4 1 7.5.3 2.3-1.6 5.8-1.4 4 2.2 3 .7.4-7.4 1.6.5 2.3-1.3-.4-1.6-2.4-1.1-2.2 1-2.4-1.1-1.3-2.8.2-2.7-.6-2.7-3.4-3.7-1.9-2.6-1.8-1.9-1.6-.6z" },
  { name: 'Corea del Sud', flag: '\u{1F1F0}\u{1F1F7}', shape: "M1637.3 331.7l6.2 5.5-3.4 1.1 5.2 6.8 1.1 4.8 2.1 3.5 4.5-.5 3.2-2.7 4.2-1.2.5-3.6-3.4-7.5-3.3-4.2-8.2-7.6.1 1.6-2.1.4-3.5.3-.7 2.9-2.4-.2-.1.6z" },
  { name: 'Colombia', flag: '\u{1F1E8}\u{1F1F4}', shape: "M578.3 497.2l1.2-2.1-1.3-1.7-2-.4-2.9 3.1-2.3 1.4-4.6 3.2-4.3-.5-.5 1.3-3.6.1-3.3 3-1.4 5.4-.1 2.1-2.4.7-4.4 4.4-2.9-.2-.7.9 1.1 3.8-1.1 1.9-1.8-.5-.9 3.1 2.2 3.4.6 5.4-1.2 1.6 1.1 5.9-1.2 3.7 2 1.5-2.2 3.3-2.5 4-2.8.4-1.4 2.3.2 3.2-2.1.5.8 2 5.6 3.6 1-.1 1.4 2.7 4.7.9 1.6-1 2.8 2.1 2.4 1.5 1.5-.6 3.7 3 1.8 3 2.7 1.7 3.4 6.7 4.2.8 3-1.7 2.1 1.1 3.3-.6 4.4 3-3.5 6.5 1.7.1 2.9 3.4 2.2-17.4.1-2.8-.9-3.6-2.5-2.4v-4.6l3.2-1 1.1.6.2-2.4-3.3-.7v-3.9l10.9.1 1.9-2.2 1.6 2 1 3.8 1.1-.8-1.7-6.4-1.4-2.2-2-1.4 2.9-3.1-.2-1.5-1.5-1.9-1-4.2.5-4.6 1.3-2.1 1.2-3.4-2-1.1-3.2.7-4-.3-2.3.7-3.8-5.5-3.2-.8-7.2.6-1.3-2.2-1.3-.6-.2-1.3.8-2.4-.4-2.5-1.1-1.4-.6-2.9-2.9-.5 1.8-3.7.9-4.5 1.8-2.4 2.2-1.8 1.6-3.2 3.7-1.1z" },
  { name: 'Argentina', flag: '\u{1F1E6}\u{1F1F7}', shape: "M669.8 920.7l.9-3-7.3-1.5-7.7-3.6-4.3-4.6-3-2.8 5.9 13.5h5l2.9.2 3.3 2.1 4.3-.3zm-50.4-208.1l-7.4-1.5-4 5.7.9 1.6-1.1 6.6-5.6 3.2 1.6 10.6-.9 2 2 2.5-3.2 4-2.6 5.9-.9 5.8 1.7 6.2-2.1 6.5 4.9 10.9 1.6 1.2 1.3 5.9-1.6 6.2 1.4 5.4-2.9 4.3 1.5 5.9 3.3 6.3-2.5 2.4.3 5.7.7 6.4 3.3 7.6-1.6 1.2 3.6 7.1 3.1 2.3-.8 2.6 2.8 1.3 1.3 2.3-1.8 1.1 1.8 3.7 1.1 8.2-.7 5.3 1.8 3.2-.1 3.9-2.7 2.7 3.1 6.6 2.6 2.2 3.1-.4 1.8 4.6 3.5 3.6 12 .8 4.8.9 2.2.4-4.7-3.6-4.1-6.3.9-2.9 3.5-2.5.5-7.2 4.7-3.5-.2-5.6-5.2-1.3-6.4-4.5-.1-4.7 2.9-3.1 4.7-.1.2-3.3-1.2-6.1 2.9-3.9 4.1-1.9-2.5-3.2-2.2 2-4-1.9-2.5-6.2 1.5-1.6 5.6 2.3 5-.9 2.5-2.2-1.8-3.1-.1-4.8-2-3.8 5.8.6 10.2-1.3 6.9-3.4 3.3-8.3-.3-3.2-3.9-2.8-.1-4.5-7.8-5.5-.3-3.3-.4-4.2.9-1.4-1.1-6.3.3-6.5.5-5.1 5.9-8.6 5.3-6.2 3.3-2.6 4.2-3.5-.5-5.1-3.1-3.7-2.6 1.2-.3 5.7-4.3 4.8-4.2 1.1-6.2-1-5.7-1.8 4.2-9.6-1.1-2.8-5.9-2.5-7.2-4.7-4.6-1-11.2-10.4-1-1.3-6.3-.3-1.6 5.1-3.7-4.6z" },
  { name: 'Messico', flag: '\u{1F1F2}\u{1F1FD}', shape: "M444.4 407.8l-3.6-1.4-3.9-2-.8-3-.2-4.5-2.4-3.6-1-3.7-1.6-4.4-3.1-2.5-4.4.1-4.8 5-4-1.9-2.2-1.9-.4-3.5-.8-3.3-2.4-2.8-2.1-2-1.3-2.2h-9.3l-.8 2.6h-15l-10.7-4.4-7.1-3.1 1-1.3-7 .7-6.3.5.2 5.7.7 5.1.7 4.1.8 4 2.6 1.8 2.9 4.5-1 2.9-2.7 2.3-2.1-.3-.6.5 2.3 3.7 2.9 1.5 1 1.7.9-.9 3.1 2.9 2.1 2 .1 3.4-1.2 4.7 2.5 1.6 3.3 3.1 2.9 3.6.7 3.9h1l2.7-2.3.4-1.2-1.5-2.8-1.6-2.9-2.6-.2.4-3.4-.9-3-1-2.8-.5-5.9-2.6-3.2-.6-2.3-1.2-1.6v-4.1l-1 .1-.1-2.2-.7-.5-.4-1.4-2.7-4.4-1.1-2.6 1-4.8.1-3 1.8-2.6 2.4 1.7 1.9-.2 3.1 2.5-.9 2.4.4 4.9 1.5 4.7-.4 2 1.7 3.1 2.3 3.4 2.7.5.3 4.4 2.4 3.1 2.5 1.5-1.8 4 .7 1.5 4.1 2.6 1.9 4 4.5 4.9 3.8 6.4 1.3 3.2v2.5l1.4 2.9-.3 2.2-1.6 1.6.3 1.8-1.9.7.8 3.1 2.2 4 5.3 3.6 1.9 2.9 5.4 2 3 .4 1.2 1.7 4.2 3 5.9 3 4 .9 4.8 2.9 4 1.2 3.7 1.7 2.9-.7 4.8-2.4 3.1-.4 4.4 1.6 2.6 2.1 5.5 6.9.4-1.9.8-1.5-.7-1.2 3.3-5.2h7.1l.4-2.1-.8-.4-.5-1.4-1.9-1.5-1.8-2.1h2.6l.4-3.6h5.2l5.1.1.1-1 .7-.3.9.8 2.5-3.9h1l1.2-.1 1.2 1.6 2-5 1.2-2.7-.9-1.1 1.8-3.9 3.5-3.8.6-3.1-1.2-1.3-3.4.5-4.8-.2-6 1.5-4 1.7-1.2 1.8-1.2 5.4-1.8 3.7-3.9 2.6-3.6 1.1-4.3 1.1-4.3.6-5.1 1.8-1.9-2.6-5.6-1.7-1.8-3.2-.7-3.6-3-4.7-.4-5-1.2-3.1-.5-3.4 1.1-3.1 1.8-8.6 1.8-4.5 3.1-5.6-2.1.2z" },
  { name: 'Giappone', flag: '\u{1F1EF}\u{1F1F5}', shape: "M1692.5 354.9l-4.5-1.3-1.1 2.7-3.3-.8-1.3 3.8 1.2 3 4.2 1.8-.1-3.7 2.1-1.5 3.1 2.1 1.3-3.9-1.6-2.2zm24.4-19.3l-3.6-6.7 1.3-6.4-2.8-5.2-8.1-8.7-4.8 1.2.2 3.9 5.1 7.1 1 7.9-1.7 2.5-4.5 6.5-5-3.1v11.5l-6.3-1.3-9.6 1.9-1.9 4.4-3.9 3.3-1.1 4-4.3 2 4 4.3 4.1 1.9.9 5.7 3.5 2.5 2.5-2.7-.8-10.8-7.3-4.7 6.1-.1 5-3 8.6-1.4 2.4 4.8 4.6 2.4 4.4-7.3 9.1-.4 5.4-3 .6-4.6-2.5-3.2-.6-5.2zm-11.8-44.2l-5.3-2.1-10.4-6.4 1.9 4.8 4.3 8.5-5.2.4.6 4.7 4.6 6.1h5.7l-1.6-6.8 10.8 4.2.4-6.1 6.4-1.7-6-6.9-1.7 2.6-4.5-1.3z" },
  { name: 'India', flag: '\u{1F1EE}\u{1F1F3}', shape: "M1414.1 380.1l-8.5-4.4-6.2-4-3.2-7 4.1.9-.6-3.3-3-3.3-.8-5.2-7.6-7.5-3.7 5.4-5.7 1-8.5-1.6-1.9 2.8 3.2 5.6 2.9 4.3 5 3.1-3.7 3.7 1 4.5-3.9 6.3-2.1 6.5-4.5 6.7-6.4-.5-4.9 6.6 4 2.9 1.3 4.9 3.5 3.2 1.8 5.5h-12l-3.2 4.2 7.1 5.4 1.9 2.5-2.4 2.3 8 7.7 4 .8 7.6-3.8 1.7 5.9.8 7.8 2.5 8.1 3.6 12.3 5.8 8.8 1.3 3.9 2 8 3.4 6.1 2.2 3 2.5 6.4 3.1 8.9 5.5 6 2.2-1.8 1.7-4.4 5-1.8-1.8-2.1 2.2-4.8 2.9-.3-.7-10.8 1.9-6.1-.7-5.3-1.9-8.2 1.2-4.9 2.5-.3 4.8-2.3 2.6-1.6-.3-2.9 5-4.2 3.7-4 5.3-7.5 7.4-4.2 2.4-3.8-.9-4.8 6.6-1.3 3.7.1.5-2.4-1.6-5.2-2.6-4.8.4-3.8-3.7-1.7.8-2.3 3.1-2.4-4.6-3.4 1.2-4.3 4.8 2.7 2.7.4 1.2 4.4 5.4.9 5-.1 3.4 1.1-1.6 5.3-2.4.4-1.1 3.6 3.5 3.3.2-4 1.5-.1 4.5 10.1 2.4-1.5-.9-2.7.9-2.1-.9-6.6 4.6 1.4 1.5-5.2-.3-3.1 2.1-5.4-.9-3.6 6.1-4.4 4.1 1.1-1.3-3.9 1.6-1.2-.9-2.4-6.1-.9 1.2-2.7-3.5-3.9-3.2 2.6-4.9-1.5-5.3 4-3.9 4.8-4.2.8 2.7 2 .4 3.9-4.4.2-4.7-.4-3.2 1-5.5-2.5-.3-1.2-1.5-5.1-3 1.4.1 2.7 1.5 4.1-.1 2.5-4.6.1-6.8-1.5-4.3-.6-3.8-3.2-7.6-.9-7.7-3.5-5.8-3.1-5.7-2.5.9-5.9 2.8-2.9z" },
  { name: 'Cile', flag: '\u{1F1E8}\u{1F1F1}', shape: "M648.4 905.2l-3.7-.7-3.3 2.5.2 4.1-1.2 2.8-7.2-2.2-8.6-4-4.5-1.3 9.7 6.8 6.3 3.2 7.5 3.4 5.3.9 4.3 1.8 3 .5 2.3.1 3.2-1.8.5-2.4-2.9-.2h-5l-5.9-13.5zm-47.3-196.3l-3.7-7.1 1.1-6.2-3.2-2.7-1.2-4.6-3.1-4.3-1.2 3.3-2.7 1.6 2.1 9 1.5 10.4-.1 14.2v13.2l.9 12.3-1.9 7.8 2.1 7.8-.5 5.3 3.2 9.5-.1 9.5-1.2 10.2-.6 10.5-2.1.2 2.4 7.3 3.3 6.3-1.1 4.3 1.9 11.6 1.5 8.8 3.5.9-1.1-7.7 4 1.6 1.8 12.7-6.4-2.1 2 10.2-2.7 5.5 8.2 1.8-3.4 4.8.2 6 5 10.6 4.2 4.1.2 3.6 3.3 3.8 7.5 3.5 7.4 4.2 6.2 2 2-.1-1.8-5.7 3.4-2.2 1.7-1.5h4.2l-4.8-.9-12-.8-3.5-3.6-1.8-4.6-3.1.4-2.6-2.2-3.1-6.6 2.7-2.7.1-3.9-1.8-3.2.7-5.3-1.1-8.2-1.8-3.7 1.8-1.1-1.3-2.3-2.8-1.3.8-2.6-3.1-2.3-3.6-7.1 1.6-1.2-3.3-7.6-.7-6.4-.3-5.7 2.5-2.4-3.3-6.3-1.5-5.9 2.9-4.3-1.4-5.4 1.6-6.2-1.3-5.9-1.6-1.2-4.9-10.9 2.1-6.5-1.7-6.2.9-5.8 2.6-5.9 3.2-4-2-2.5.9-2-1.6-10.6 5.6-3.2 1.1-6.6-.9-1.6-3.8.9-3.1-8.8z" },
  { name: 'Nigeria', flag: '\u{1F1F3}\u{1F1EC}', shape: "M1055.8 492.7l-1 .2-3.9-7-1.3-.2-4.3 3.5-4.3-1.8-3-.4-1.6.9-3.3-.2-3.3 2.7-2.8.2-6.8-3.3-2.6 1.5-2.9-.1-2.1-2.4-5.6-2.4-6 .8-1.4 1.4-.8 3.6-1.6 2.6-.3 5.7-.2 2.1 1.2 3.8-1.1 2.5.6 1.7-2.7 4-1.7 1.9-1 4 .1 4.1-.3 10.2h9.2l3.9 4.2 1.9 4.6 3 3.9 4.5.2 2.2-1.4 2.1.3 5.8-2.3 1.4-4.5 2.7-6.1 1.6-.1 3.3-3.7 2.1-.1 3.2 2.6 3.9-2.2.5-2.6 1.2-2.6.8-3.2 3-2.6 1.1-4.5 1.2-1.4.7-3.3 1.5-4 4.6-5 .3-2.1.6-1.1-2.3-2.6z" },
  { name: 'Kenya', flag: '\u{1F1F0}\u{1F1EA}', shape: "M1211.7 547.2h-3.8l-2.3-2.1-5.1 2.6-1.6 2.7-3.8-.5-1.2-.7-1.3.1h-1.8l-7.2-5.4h-3.9l-2-2.1v-3.6l-2.9-1.1-3.8 4.2-3.4 3.8 2.7 4.4.7 3.2 2.6 7.3-2.1 4.7-2.7 4.2-1.6 2.6v.3l1.4 2.4-.4 4.7 20.2 13 .4 3.7 8 6.3 2.2-2.1 1.2-4.2 1.8-2.6.9-4.5 2.1-.4 1.4-2.7 4-2.5-3.3-5.3-.2-23.2 4.8-7.2z" },
  { name: 'Marocco', flag: '\u{1F1F2}\u{1F1E6}', shape: "M965.2 348.4l-2.3-.1-5.5-1.4-5 .4-3.1-2.7h-3.9l-1.8 3.9-3.7 6.7-4 2.6-5.4 2.9-3.5 4.3-.9 3.4-2.1 5.4 1.1 7.9-4.7 5.3-2.7 1.7-4.4 4.4-5.1.7-2.8 2.4-.1.1-3.6 6.5-3.7 2.3-2.1 4-.2 3.3-1.6 3.8-1.9 1-3.1 4-2 4.5.3 2.2-1.9 3.3-2.2 1.7-.3 3h.1l12.4-.5.7-2.3 2.3-2.9 2-8.8 7.8-6.8 2.8-8.1 1.7-.4 1.9-5 4.6-.7 1.9.9h2.5l1.8-1.5 3.4-.2-.1-3.4h.8l.1-7.5 8.9-4.7 5.4-1 4.4-1.7 2.1-3.2 6.3-2.5.3-4.7 3.1-.5 2.5-2.4 7-1 1-2.5-1.4-1.4-1.8-6.7-.3-3.9-2-4.1z" },
  { name: 'Cuba', flag: '\u{1F1E8}\u{1F1FA}', shape: "M539 427.3l-4.9-2.1-4.3-.1-4.7-.5-1.4.7-4.2.6-3 1.3-2.7 1.4-1.5 2.3-3.1 2 2.2.6 2.9-.7.9-1.6 2.3-.1 4.4-3.3 5.4.3-2.3 1.6 1.8 1.3 7 1 1.5 1.3 4.9 1.7 3.2-.2.8 3.6 1.7 1.8 3.5.4 2.1 1.7-4.1 3.5 7.9-.6 3.8.5 3.7-.3 3.8-.8.8-1.5-3.9-2.6-4-.3.6-1.7-3.1-1.3h-1.9l-3-2.8-4.2-4-1.8-1.5-5.2.8-1.9-2.4z" },
  { name: 'Islanda', flag: '\u{1F1EE}\u{1F1F8}', shape: "M915.7 158.6l-6.9-.4-7.3 2.9-5.1-1.5-6.9 3-5.9-3.8-6.5.8-3.6 3.7 8.7 1.3-.1 1.6-7.8 1.1 8.8 2.7-4.6 2.5 11.7 1.8 5.6.8 3.9-1 12.9-3.9 6.1-4.2-4.4-3.8 1.4-3.6z" },
  { name: 'Finlandia', flag: '\u{1F1EB}\u{1F1EE}', shape: "M1093.4 144.4l.8-3.8-5.7-2.1-5.8 1.8-1.1 3.9-3.4 2.4-4.7-1.3-5.3.3-5.1-2.9-2.1 1.4 5.9 2.7 7.2 3.7 1.7 8.4 1.9 2.2 6.4 2.6.9 2.3-2.6 1.2-8.7 6.1-3.3 3.6-1.5 3.3 2.9 5.2-.1 5.7 4.7 1.9 3.1 3.1 7.1-1.2 7.5-2.1 8-.5 7.9-7.4 3.3-3.3.9-2.9-7.3-3.9.9-3.7-4.9-4.1 1.7-4.8-6.4-6.3 2.8-4.1-7.2-3.7-.4-3.7z" },
  { name: 'Danimarca', flag: '\u{1F1E9}\u{1F1F0}', shape: "M1035.9 221.2l-1.7-3-6.7 2 .9 2.5 5.1 3.4 2.4-4.9zm-8.6-5.1l-2.6-.9-.7-1.6 1.3-2-.1-3-3.6 1.6-1.5 1.7-4 .4-1.2 1.7-.7 1.6.4 6.1 2.1 3.4 3.6.8 3-.9-1.5-3 3.1-4.3 1.4.7 1-2.3z" },
  { name: 'Ucraina', flag: '\u{1F1FA}\u{1F1E6}', shape: "M1138.5 241l-4.8.5-1.5-.3-1 1.4-1.8-.2-4.1.3-1.2 1.4.2 3.1-2-.6-4.3.3-1.5-1.5-1.6 1.1-2-.9-3.8-.1-5.6-1.5-5-.5-3.7.2-2.4 1.6-2.2.3 3.1 5.3-.3 1.8-2.3.7-3.8 5.1 1.6 2.8-1.1-.4-1.1 1.7-.7 2.5 2.9 1.7.6 1.6 1.9-1.3 3.2.7h3.2l2.4 1.5 1.6-.9 3.6-.6 1-1.5h2.1l1.1-.9 3.2-.6 3.9 1.9 2 .3 2.5 1.6v2.1l1.9 1.1 1.1 2.6 2 1.5-.2 1 1 .6-1.2.5-3-.2-.6-.9-1 .5.5 1.1-1.1 2-.5 2.1-1.2.7 2.4 1.1 2.2-1 2.4 1.1 3.3-4.6 1.3-3.4 4.5-.8.7 2.4 8 1.5 1.7 1.4-4.5 2.1-.7 1.2 5.8 1.8-.6 2.9 3 1.3 6.3-3.6 5.3-1.1.6-2.2-5.1.4-2.7-1.5-1-3.9 3.9-2.3 4.6-.3 3-2 3.9-.5-.4-2.8 2.2-1.7 4.7-.5.3-2.1-1.8-3.4 1.3-3.2-.4-1.9-7.6-2-2.9.1-3.6-2.9-3.5 1-6.6-2.2-.2-1.2-2.2-2.7-4-.2-.7-1.9.9-1.3-3.8-3.4z" },
  { name: 'Arabia Saudita', flag: '\u{1F1F8}\u{1F1E6}', shape: "M1228.7 387l-10.2-.5-16.7-12.7-8.5-4.5-6.7-1.7-.9 1-10.4 3.1 6.1 6.4-1.7 1-.7 2.2-4 .8-1.1 2.3-2.1 2-6.1-1-.5 2.5v2.2l-.6 3.5h2.7l3.2 4.4 3.7 5.1 2.5 4.7 1.7 1.5 1.7 3.3-.2 1.4 2.1 3.7 3 1.3 2.8 2.5 3.6 7v3.8l.9 4.4 4 6.1 2.5 1 4.1 4.4 1.9 5.2 3.2 5.3 3 2.3.6 2.5 1.8 1.9.9 2.8 2.3-2.1-.7-2.7 1.2-3.1 2.4 1.7 1.5-.6 6.4-.2 1 .7 5.4.6 2.1-.3 1.6 2.1 2.5-1 3.5-6.7 5-2.9 15.7-2.4 16.1-6.4 2.6-12.7-2.9-4.5-1 1.3-16.8-3.2-2.6-6.4-.4-1.5-1.2-2.4-1.5.4-1.8-1.2-1-1.6-.9-2.1-1.7-1.8-1-2.1.4-2.1-.6-2.7-4-2.6-1.2-2.3-2.9-1.4-2.7-5.5-3.8.2-1.7-3.1-4.9-.6z" },
  { name: 'Iran', flag: '\u{1F1EE}\u{1F1F7}', shape: "M1213.5 324.4l-3.2-2.9-1.2-2.4-3.3 1.8 2.9 7.3-.7 2 3.7 5.2 4.7 7.8 3.7 1.9 1 3.8-2.3 2.2-.5 5 4.6 6.1 7 3.4 3.5 4.9-.2 4.6h1.7l.5 3.3 3.4 3.4 1.7-2.5 3.7 2.1 2.8-1 5.1 8.4 4.3 6.1 5.5 1.8 6.1 4.9 6.9 2.1 5.1-3.1 4-1.1 2.8 1.1 3.2 7.8 6.3.8 6.1 1.5 10.5 1.9 1.2-7.4 7.4-3.3-.9-2.9-2.7-1-1-5.7-5.6-2.7-2.8-3.9-3.2-3.3 3.9-5.8-1.1-4-4.3-1.1-1.1-4-2.7-5.1 1.6-3.5-2.5-.9.5-4.7.5-8-1.6-5.5-3.9-.2-7.3-5.7-4.3-.7-6.5-3.3-3.8-.6-2.1 1.2-3.5-.2-3 3.7-4.4 1.2-.2 1.6-7.9 1.7-7.6-1.1-4.3-3.3-5.2-1.3-2.5-4.8-1.3.3-3.8-3.4 1.2-3.1-1.9-1.9-1.9.5-5.3 4.7-1.8.2-3.7-.9z" },
  { name: 'Pakistan', flag: '\u{1F1F5}\u{1F1F0}', shape: "M1388.3 346.3l-9.4-2.6-2.9-5-4.7-3-2.8.7-2.4 1.2-5.8.8-5.3 1.3-2.4 2.8 1.9 2.8 1.4 3.2-2 2.7.8 2.5-.9 2.3-5.1-.2 3 4.2-3 1.6-1.5 3.8 1.1 3.8-1.7 1.8-2.1-.6-4 .9-.2 1.7h-4l-2.3 3.6.8 5.4-6.6 2.6-3.8-.5-.9 1.4-3.3-.8-5.3.9-9.6-3.2 3.2 3.3 2.8 3.9 5.6 2.7 1 5.7 2.7 1 .9 2.9-7.4 3.3-1.2 7.4 7.6-.9 8.9-.1 9.9-1.2 4.9 4.8 2.1 4.6 4.2 1.6 3.2-4.2h12l-1.8-5.5-3.5-3.2-1.3-4.9-4-2.9 4.9-6.6 6.4.5 4.5-6.7 2.1-6.5 3.9-6.3-1-4.5 3.7-3.7-5-3.1-2.9-4.3-3.2-5.6 1.9-2.8 8.5 1.6 5.7-1 3.7-5.4z" },
  { name: 'Perù', flag: '\u{1F1F5}\u{1F1EA}', shape: "M584.3 599.5l-2.9-3.4-1.7-.1 3.5-6.5-4.4-3-3.3.6-2.1-1.1-3 1.7-4.2-.8-3.4-6.7-2.7-1.7-1.8-3-3.7-3-1.5.6.8 4.9-1.7 4.1-6 6.7-6.7 2.5-3.3 5.5-.9 4.3-3.1 2.6-2.5-3.2-2.3-.7-2.3.5-.2-2.3 1.5-1.5-.7-2.7-4.4 4-1.6 4.5 3 6.1-1.7 2.8 4.1 2.6 4.5 4.1 2 4.7 2.4 2.9 6 12.7 6.2 11.7 5.4 8.4-.8 1.8 2.8 5.3 4.6 3.9 10.7 6.9 11.6 6.4.7 2.6 5.9 3.7 2.7-1.6 1.2-3.3 2.8-6.9-2.8-5.3 1.1-2.1-1.2-2.4 1.9-3.2-.3-5.4-.1-4.5 1.1-2.1-5.5-10.3-3 1.1-2.6-.7-.2-9.7-4.4 3.8-4.9-.2-2.3-3.4-3.7-.3 1-2.8-3.3-3.8-2.6-5.8 1.5-1.1-.1-2.7 3.3-1.9-.7-3.4 1.3-2.2.4-3 6.2-4.3 4.6-1.2.7-1 5.1.3z" },
  { name: 'Nuova Zelanda', flag: '\u{1F1F3}\u{1F1FF}', shape: "M1868.6 832.8l.9-2.6-5.8 2.9-3.4 3.4-3.2 1.6-5.9 4.6-5.6 3.2-7 3.2-5.5 2.4-4.3 1.1-11.3 6.1-6.4 4.6-1.1 2.3 5.1.4 1.5 2.1 4.5.1 4-1.8 6.3-2.8 8.1-6.2 4.7-4.1 6.2-2.3 4-.1.6-2.9 4.6-2.5 7-4.5 4.2-2.9 2.1-2.6.5-2.6-5.6 2.5.8-2.6zm28.8-30.5l1.9-5.7-3.1-1.7-.8-3.6-2.3.5-.4 4.6.8 5.7.9 2.7-.9 1.1-.6 4.4-2.4 4.1-4.2 5-5.3 2.2-1.7 2.4 3.7 2.5-.8 3.5-6.9 5.1 1.4.9-.4 1.6 5.9-2.5 5.9-4.2 4.5-3.4 1.6-1.2 1.5-2.7 2.8-2 3.8.2 4.2-3.8 5.1-5.7-2.1-.8-4.6 2.5-3.2-.5-2.9-2.1 2.3-4.9-1.2-1.8-2.9 4.4.4-6.8z" },
  { name: 'Vietnam', flag: '\u{1F1FB}\u{1F1F3}', shape: "M1571.6 435l-5.9-1.6-3-2.6.2-3.7-5.2-1.1-3-2.4-4.1 3.4-5.3.7h-4.3l-2.7 1.5 4 5.1 3.4 5.7 6.8.1 3 5.5-3.3 1.7-1.3 2.3 7.3 3.8 5.7 7.5 4.3 5.6 4.8 4.4 2 4.5-.2 6.4 1.8 4.2.1 7.7-8.9 4.9 2.8 3.8-5.8.5-4.7 2.5 4.5 3.7-1.3 4.3 2.3 4 6.6-5.9 4.1-5.3 6.1-4.1 4.3-4.2-.4-11.2-4-11.7-4.1-5.1-5.6-4-6.4-8.3-5.3-6.7.5-4.4 3.7-6 6.5-5.5z" },
  { name: 'Thailandia', flag: '\u{1F1F9}\u{1F1ED}', shape: "M1562.7 481.4l1.5-2.9-.5-5.4-5.2-5.5-1.3-6.3-4.9-5.2-4.3-.4-.8 2.2-3.2.2-1.8-1.2-5.3 3.8-1-5.7.4-6.7-3.8-.3-.9-3.8-2.6-1.9-3 1.4-2.8 2.8-3.9.3-1.5 6.9-2.2 1.1 3.5 5.6 4.1 4.6 2.9 4.2-1.4 5.6-1.7 1.1 1.7 3.2 4.2 5.1 1 3.5.2 3 2.8 5.8-2.6 5.9-2.2 6.6-1.3 6.1-.3 3.9 1.2 3.6.7-3.8 2.9 3.1 3.2 3.5 1.1 3.2 2.4 2.4.9-1.1 4.7 2.8.6 3.3 3.7-.8 1.7-2.6-3.1-3.3-3.4-.8-3.3-3.6-1.4-5.5-2.6-5.8-3.7-.2-.7-4.6 1.4-5.6 2.2-9.3-.2-7 4.9-.1-.3 5 4.7-.1 5.3 2.9-2.1-7.7 3-5.2 7.1-1.3 5.3 1z" },
];

// ─── Game Modes ─────────────────────────────────────────────────
const MODES = {
  'Misto': 'mixed',
  'Sagome': 'shape',
  'Bandiere': 'flag'
};
const MODE_KEYS = Object.keys(MODES);
let selectedMode = 'Misto';

// ─── Persistence (localStorage) ─────────────────────────────────
const STORAGE_KEY = 'confini_stats';

function loadStats() {
  try {
    const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (data && typeof data.gamesPlayed === 'number') return data;
  } catch(e) {}
  return { gamesPlayed: 0, gamesWon: 0, currentStreak: 0, maxStreak: 0, lastPlayed: null, totalCorrect: 0, totalRounds: 0, bestTimeMs: null };
}

function saveStats() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(stats));
}

let stats = loadStats();

// ─── Game State ─────────────────────────────────────────────────
const ROUNDS_PER_GAME = 10;
let rounds = [];
let currentRound = 0;
let score = 0;
let roundResults = [];
let gameActive = false;
let roundStartMs = 0;
let roundTimesMs = [];
let totalGameMs = 0;
let timerInterval = null;

// ─── DOM refs ───────────────────────────────────────────────────
const gameArea = document.getElementById('gameArea');
const statsLine = document.getElementById('statsLine');
const modeSelector = document.getElementById('modeSelector');
const btnStart = document.getElementById('btnStart');
const startToolbar = document.getElementById('startToolbar');
const instructionsEl = document.getElementById('instructions');

// ─── Mode Selector ──────────────────────────────────────────────
function renderModes() {
  modeSelector.innerHTML = '';
  MODE_KEYS.forEach(m => {
    const chip = document.createElement('button');
    chip.className = 'mode-chip' + (m === selectedMode ? ' active' : '');
    chip.textContent = m;
    chip.onclick = () => {
      selectedMode = m;
      renderModes();
    };
    modeSelector.appendChild(chip);
  });
}

// ─── Stats Display ──────────────────────────────────────────────
function updateStatsDisplay() {
  const avg = stats.totalRounds > 0 ? Math.round(stats.totalCorrect / stats.totalRounds * 100) : 0;
  statsLine.textContent = `Partite: ${stats.gamesPlayed} \u00b7 Precisione: ${avg}% \u00b7 Streak: ${stats.currentStreak}`;
}

function showStatsModal() {
  const avg = stats.totalRounds > 0 ? Math.round(stats.totalCorrect / stats.totalRounds * 100) : 0;
  document.getElementById('statsContent').innerHTML = `
    <div class="stat-row"><span class="stat-label">Partite giocate</span><span class="stat-value">${stats.gamesPlayed}</span></div>
    <div class="stat-row"><span class="stat-label">Partite vinte (\u22657/10)</span><span class="stat-value">${stats.gamesWon}</span></div>
    <div class="stat-row"><span class="stat-label">Risposte corrette</span><span class="stat-value">${stats.totalCorrect}/${stats.totalRounds}</span></div>
    <div class="stat-row"><span class="stat-label">Precisione</span><span class="stat-value">${avg}%</span></div>
    <div class="stat-row"><span class="stat-label">Streak attuale</span><span class="stat-value">${stats.currentStreak}</span></div>
    <div class="stat-row"><span class="stat-label">Miglior streak</span><span class="stat-value">${stats.maxStreak}</span></div>
    <div class="stat-row"><span class="stat-label">Miglior tempo</span><span class="stat-value">${stats.bestTimeMs !== null ? formatTime(stats.bestTimeMs) : '-'}</span></div>
  `;
  document.getElementById('statsOverlay').classList.add('visible');
}

// ─── Compute bounding box from SVG path and generate silhouette ─
function parseBBox(path) {
  const nums = path.match(/-?\d+\.?\d*/g);
  if (!nums) return '0 0 100 100';
  let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
  // Parse path commands to extract absolute coordinates
  const cmds = path.match(/[MmLlHhVvCcSsQqTtAaZz][-\d.,\s]*/g) || [];
  let cx = 0, cy = 0;
  for (const cmd of cmds) {
    const c = cmd[0];
    const vals = cmd.slice(1).trim().match(/-?\d+\.?\d*/g);
    if (!vals) continue;
    const n = vals.map(Number);
    if (c === 'M' || c === 'L') {
      for (let i = 0; i < n.length; i += 2) {
        cx = n[i]; cy = n[i+1];
        if (cx < minX) minX = cx; if (cx > maxX) maxX = cx;
        if (cy < minY) minY = cy; if (cy > maxY) maxY = cy;
      }
    } else if (c === 'm' || c === 'l') {
      for (let i = 0; i < n.length; i += 2) {
        cx += n[i]; cy += n[i+1];
        if (cx < minX) minX = cx; if (cx > maxX) maxX = cx;
        if (cy < minY) minY = cy; if (cy > maxY) maxY = cy;
      }
    } else if (c === 'H') { cx = n[0]; if (cx < minX) minX = cx; if (cx > maxX) maxX = cx; }
    else if (c === 'h') { cx += n[0]; if (cx < minX) minX = cx; if (cx > maxX) maxX = cx; }
    else if (c === 'V') { cy = n[0]; if (cy < minY) minY = cy; if (cy > maxY) maxY = cy; }
    else if (c === 'v') { cy += n[0]; if (cy < minY) minY = cy; if (cy > maxY) maxY = cy; }
    else if (c === 'C') { for (let i = 0; i < n.length; i += 6) { cx = n[i+4]; cy = n[i+5]; if (cx < minX) minX = cx; if (cx > maxX) maxX = cx; if (cy < minY) minY = cy; if (cy > maxY) maxY = cy; } }
    else if (c === 'c') { for (let i = 0; i < n.length; i += 6) { cx += n[i+4]; cy += n[i+5]; if (cx < minX) minX = cx; if (cx > maxX) maxX = cx; if (cy < minY) minY = cy; if (cy > maxY) maxY = cy; } }
    else if (c === 'z' || c === 'Z') { /* no-op */ }
  }
  const pad = 5;
  return `${minX - pad} ${minY - pad} ${maxX - minX + pad*2} ${maxY - minY + pad*2}`;
}

// Pre-compute viewBoxes and build COUNTRIES array
const COUNTRIES = COUNTRIES_RAW.map(c => {
  c.viewBox = parseBBox(c.shape);
  return c;
});

function renderSilhouette(country) {
  return `<svg viewBox="${country.viewBox}" xmlns="http://www.w3.org/2000/svg">
    <path d="${country.shape}" fill="#6C5CE7" stroke="#5a4bd6" stroke-width="1" stroke-linejoin="round"/>
  </svg>`;
}

// ─── Build rounds ───────────────────────────────────────────────
function buildRounds() {
  const seed = Date.now();
  const rng = mulberry32(seed);

  const pool = [...COUNTRIES];
  shuffleArray(pool, rng);

  const roundsData = [];

  for (let i = 0; i < ROUNDS_PER_GAME; i++) {
    const correct = pool[i];

    // Pick round type
    let type;
    const mode = MODES[selectedMode];
    if (mode === 'mixed') {
      type = rng() > 0.5 ? 'flag' : 'shape';
    } else {
      type = mode;
    }

    // Pick 3 distractors from remaining pool
    const distractors = [];
    const available = pool.filter((c, idx) => idx !== i);
    shuffleArray(available, rng);

    // Try to pick countries from same "region" for harder distractors
    for (const c of available) {
      if (distractors.length >= 3) break;
      if (c.name !== correct.name) {
        distractors.push(c);
      }
    }

    const options = shuffleArray([
      { name: correct.name, isCorrect: true },
      ...distractors.map(d => ({ name: d.name, isCorrect: false }))
    ], rng);

    roundsData.push({
      correct,
      type,
      options
    });
  }

  return roundsData;
}

// ─── Start Game ─────────────────────────────────────────────────
function startGame() {
  gameActive = false;
  currentRound = 0;
  score = 0;
  roundResults = [];
  roundTimesMs = [];
  totalGameMs = 0;
  instructionsEl.style.display = 'none';

  rounds = buildRounds();
  gameActive = true;
  startToolbar.style.display = 'none';
  modeSelector.parentElement.style.display = 'none';
  renderRound();
}

// ─── Render Round ───────────────────────────────────────────────
function renderRound() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }

  const round = rounds[currentRound];
  const typeLabel = round.type === 'flag' ? 'Che stato ha questa bandiera?' : 'Che stato ha questa forma?';

  let visualContent;
  if (round.type === 'flag') {
    visualContent = `<span class="flag-display">${round.correct.flag}</span>`;
  } else {
    visualContent = renderSilhouette(round.correct);
  }

  gameArea.innerHTML = `
    <div class="score-dots" id="scoreDots"></div>
    <div class="question-card">
      <div class="question-label">Round ${currentRound + 1} di ${ROUNDS_PER_GAME}</div>
      <div class="question-visual">${visualContent}</div>
      <div class="question-label">${typeLabel}</div>
      <div style="display:flex;align-items:center;gap:8px;width:100%;">
        <div class="timer-bar"><div class="timer-fill" id="timerFill"></div></div>
        <span class="timer-text" id="timerText">0.0s</span>
      </div>
    </div>
    <div class="options" id="optionsContainer"></div>
  `;

  renderScoreDots();
  renderOptions(round);

  roundStartMs = performance.now();

  // Start visual timer
  timerInterval = setInterval(() => {
    const elapsed = performance.now() - roundStartMs;
    const seconds = elapsed / 1000;
    const timerText = document.getElementById('timerText');
    const timerFill = document.getElementById('timerFill');
    if (timerText) timerText.textContent = seconds.toFixed(1) + 's';
    if (timerFill) {
      // Timer bar shrinks over 15 seconds
      const pct = Math.max(0, 100 - (seconds / 15) * 100);
      timerFill.style.width = pct + '%';
      timerFill.className = 'timer-fill' + (seconds > 10 ? ' danger' : seconds > 6 ? ' warning' : '');
    }
  }, 100);
}

function renderScoreDots() {
  const container = document.getElementById('scoreDots');
  if (!container) return;
  container.innerHTML = '';
  for (let i = 0; i < ROUNDS_PER_GAME; i++) {
    const dot = document.createElement('div');
    dot.className = 'score-dot';
    if (i < roundResults.length) {
      dot.classList.add(roundResults[i] ? 'correct' : 'wrong');
    } else if (i === currentRound) {
      dot.classList.add('current');
    }
    container.appendChild(dot);
  }
}

function renderOptions(round) {
  const container = document.getElementById('optionsContainer');
  container.innerHTML = '';
  round.options.forEach((opt, idx) => {
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.textContent = opt.name;
    btn.onclick = () => handleAnswer(idx, opt.isCorrect, round);
    container.appendChild(btn);
  });
}

// ─── Handle Answer ──────────────────────────────────────────────
function handleAnswer(selectedIdx, isCorrect, round) {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }

  const elapsed = Math.round(performance.now() - roundStartMs);
  roundTimesMs.push(elapsed);
  totalGameMs += elapsed;

  const buttons = document.querySelectorAll('.option-btn');
  buttons.forEach((btn, i) => {
    btn.style.pointerEvents = 'none';
    if (round.options[i].isCorrect) {
      btn.classList.add('correct');
    } else if (i === selectedIdx && !isCorrect) {
      btn.classList.add('wrong');
    } else {
      btn.classList.add('dimmed');
    }
  });

  if (isCorrect) score++;
  roundResults.push(isCorrect);

  // Show answer feedback
  const container = document.getElementById('optionsContainer');
  const info = document.createElement('div');
  info.className = 'answer-info ' + (isCorrect ? 'correct-info' : 'wrong-info');
  if (isCorrect) {
    info.textContent = `Corretto! ${formatTime(elapsed)}`;
  } else {
    info.textContent = `Sbagliato! Era ${round.correct.name}`;
  }
  container.appendChild(info);

  renderScoreDots();

  setTimeout(() => {
    currentRound++;
    if (currentRound < ROUNDS_PER_GAME) {
      renderRound();
    } else {
      endGame();
    }
  }, 1500);
}

// ─── End Game ───────────────────────────────────────────────────
function endGame() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  gameActive = false;

  stats.gamesPlayed++;
  stats.totalCorrect += score;
  stats.totalRounds += ROUNDS_PER_GAME;
  stats.lastPlayed = new Date().toISOString().slice(0, 10);

  const won = score >= 7;
  if (won) {
    stats.gamesWon++;
    stats.currentStreak++;
    if (stats.currentStreak > stats.maxStreak) stats.maxStreak = stats.currentStreak;
  } else {
    stats.currentStreak = 0;
  }

  const isNewBest = won && (stats.bestTimeMs === null || totalGameMs < stats.bestTimeMs);
  if (isNewBest) stats.bestTimeMs = totalGameMs;

  saveStats();
  updateStatsDisplay();

  let title, titleClass;
  if (score >= 9) { title = 'Incredibile!'; titleClass = 'great'; }
  else if (score >= 7) { title = 'Ottimo!'; titleClass = 'great'; }
  else if (score >= 5) { title = 'Non male!'; titleClass = 'ok'; }
  else { title = 'Puoi fare di meglio!'; titleClass = 'bad'; }

  const avgMs = Math.round(totalGameMs / ROUNDS_PER_GAME);
  const timeStr = formatTime(totalGameMs);
  const avgStr = formatTime(avgMs);
  const bestStr = stats.bestTimeMs !== null ? formatTime(stats.bestTimeMs) : '-';

  gameArea.innerHTML = `
    <div class="score-dots" id="scoreDots"></div>
    <div class="result-container">
      <div class="result-title ${titleClass}">${title}</div>
      <div class="result-score">${score}/${ROUNDS_PER_GAME}</div>
      <div class="result-detail">
        Tempo totale: <strong>${timeStr}</strong> \u00b7 Media: <strong>${avgStr}</strong>/round<br>
        ${isNewBest ? '<span style="color:var(--success);font-weight:700;">Nuovo record!</span><br>' : ''}
        Record: <strong>${bestStr}</strong><br>
        ${won ? `Streak: ${stats.currentStreak}` : 'La streak si azzera sotto 7 risposte corrette'}
      </div>
      <button class="btn btn-primary" id="btnPlayAgain">Gioca ancora</button>
    </div>
  `;

  renderScoreDots();
  document.getElementById('btnPlayAgain').onclick = resetToMenu;
}

// ─── Reset to Menu ──────────────────────────────────────────────
function resetToMenu() {
  if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
  gameActive = false;
  gameArea.innerHTML = '';
  startToolbar.style.display = '';
  btnStart.disabled = false;
  btnStart.textContent = 'Nuova partita';
  modeSelector.parentElement.style.display = '';
  instructionsEl.style.display = '';
  updateStatsDisplay();
}

// ─── Utility ────────────────────────────────────────────────────
function formatTime(ms) {
  const totalSec = ms / 1000;
  if (totalSec < 60) return totalSec.toFixed(1) + 's';
  const min = Math.floor(totalSec / 60);
  const sec = (totalSec % 60).toFixed(1);
  return `${min}m ${sec}s`;
}

// ─── Event Handlers ─────────────────────────────────────────────
btnStart.addEventListener('click', startGame);
document.getElementById('btnStats').addEventListener('click', showStatsModal);

// ─── Init ───────────────────────────────────────────────────────
renderModes();
updateStatsDisplay();
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
